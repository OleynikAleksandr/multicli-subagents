---
trigger: always_on
---

# Мастер-процесс и Архитектура

**СИСТЕМНАЯ ИНСТРУКЦИЯ**: 
Это ГЛАВНАЯ директива для всех сессий разработки. Ты ОБЯЗАН строго следовать этому жизненному циклу.

## 1. Управление сессиями (Session Lifecycle)

### Начало сессии
1. **Чтение отчета**: Найди последний файл `doc/Sessions/SessionXXX.md`.
2. **ГЛУБОКИЙ АНАЛИЗ ИСТОРИИ (КРИТИЧНО)**:
   - Раздел "Git commits" в отчете — это **ключ к контексту**.
   - Ты ОБЯЗАН просмотреть каждый коммит из списка, используя `git show --stat <hash>` (чтобы видеть файлы) и `git show <hash>` (чтобы видеть изменения).
   - **ЦЕЛЬ**: Полностью восстановить в памяти, какие файлы менялись, какая логика была добавлена/изменена, чтобы продолжить работу бесшовно, как будто перерыва не было.
   - Просто прочитать сообщение коммита — **НЕДОСТАТОЧНО**.
3. **План**: Изучи раздел "Instructions for Next Session" из отчета.
4. **Контекст**: Прочти архитектурные документы, указанные в отчете.

### Конец сессии
1. **Отчет**: Создай или обнови отчет `doc/Sessions/SessionXXX.md` по следующему шаблону:

```markdown
# Session <N> — <Краткое название темы сессии>

**Date:** YYYY-MM-DD HH:MM (Timezone)
**Branch:** <branch_name>
**Version:** <current_version>

---

# 1. Work Done in This Session

## Work summary
- <Краткое описание выполненной задачи 1>
- <Краткое описание выполненной задачи 2>
- <Результаты сборки/тестов>

## Git commits
(ВАЖНО: Этот список нужен для следующей сессии, чтобы восстановить контекст через git show)
- `<hash> <commit_message>`
- `<hash> <commit_message>`

---

# 2. Instructions for Next Session

## Required documents to review before work
1. `doc/Architecture/Architecture.md`
2. `doc/Project_Docs/SystemArchitecture/SystemArchitecture.md`
3. `doc/TODO/todo-plan.md`
4. `doc/Sessions/Session<N>.md` (THIS REPORT)

## Plans for next session
- <Что осталось сделать>
- <Какие модули требуют внимания>
```
   - **Никакого отдельного `walkthrough.md`**. Лог сессии И ЕСТЬ walkthrough.

## 2. Архитектурные принципы (Подход "Кластерно-Модульный")
- **Микро-классы**: Никаких файлов > 300 строк. Логика должна быть разбита на маленькие классы с единственной ответственностью.
- **Фасады**: Каждый модуль должен иметь Фасад (`*facade.ts`), который выступает ЕДИНСТВЕННОЙ точкой входа для внешнего взаимодействия.
- **Закрытые модули**: Если модуль работает и проверен, **НЕ ТРОГАЙ ЕГО**. Новый функционал = Новый модуль (или строго аддитивные изменения).

## 3. Этап Проектирования (Design Phase)
**Перед тем как создать или обновить `todo-plan.md`, необходимо:**
1. **Создать или обновить Архитектурный документ** в `doc/Project_Docs/` (например, `doc/Project_Docs/NewFeature_Architecture.md`).
2. В этом документе утвердить: проблему, решение, структуру классов, контракты.
3. Только **после утверждения** этого документа пользователем, мы берем его за основу и нарезаем на Фазы и Стримы в `todo-plan.md`.

## 4. Этап Планирования (Execution Planning)
- **Источник правды**: `doc/TODO/todo-plan.md` содержит Стратегию.
- **Операционный вид**: Используй `task.md` для отслеживания *текущего* активного пункта из `todo-plan.md`.
`todo-plan.md` - может содержать несколько фаз и в каждой фазе несколько Stream с перечнем микро задач - не более 3-х файлов исправлений или вновь созданных.
`task.md` - содержит всегда только Один конкретный Stream из перечня не выполненных в `todo-plan.md`.
Полностью Реализованный `todo-plan.md` переименовывается с префиксом последней реализованной Фазы (например - todo-plan-phase3.md) и кладется в папку -
doc/TODO/Archive/
На его месте создается новый `todo-plan.md` под новые задачи.
- **Ограничение**: Разбивай работу на **Микро-задачи**. Каждая задача должна затрагивать **≤ 3 файлов**.

- **Шаблон todo-plan.md**:
  ```markdown
  # План разработки (Development TODO Plan)

  ## Правила выполнения (Execution Rules):
  - **TODO Plan** состоит из Phase (Фаз). В каждой Phase некоторое колличество - Stream (стрим), в каждом Стриме - некоторое кол-во подзадач.
  - Каждая подзадача должна затрагивать не более 3 файлов - это критическое правило.
  - Если по факту разработки оказывается, что конкретная подзазача Stream затрагивает больше 3 файлов - такая задача должна быть разбита на более мелкие и список задач в Стриме переписывается.
  - **Gates**: после выполнения каждой подзадачи — ОБЯЗАТЕЛЬНО!!!! Git Commit с максимально релевантным описанием (код + доки) и апдейт `todo-plan.md` (дата, статус, хеш). Только тогда подзадача считается выполненной. ЭТО Критически важное правило! Нарушать его категорически запрещено.
  - Stream завершается после того, как все его задачи закрыты таргетными сборками затронутых пакетов/клиентов и коммитами.
  - **Real-time Документация**: 
Любое изменение архитектуры/логики требует синхронного обновления и todo-plan.md и документации (`doc/Architecture/Architecture.md` и др.) **ДО** коммита - чтоб измененные документы также попали в Git Commit.
  - Phase завершается на чистом дереве: 
запускаем `./scripts/build-all.sh` (он повышает версии) затем делаешь опять коммит и вызываеш `./scripts/build-release.sh --use-current-version`), переносим tarball’ы в `doc/tmp/releases/`, фиксируем результаты в `doc/Sessions/`.
  - **doc/TODO/todo-plan.md** необходимо постоянно в риалтайме обновлять, после каждой подзадачи обязательный коммит, после каждого коммита его номер и наименование заносить, статус задачи тут же менять.

  ## Phase <N> — <описание> (owner: <имя>, updated: YYYY-MM-DD)
  ### Stream: <Короткое название>
  1. [STATUS] <задача 1 — указать затрагиваемые файлы и ожидаемый commit id и описание>
  2. [STATUS] <задача 2>
  ```
  Статусы: `TODO`, `IN_PROGRESS`, `DONE`, `BLOCKED`. Каждый пункт обязан иметь «scope» (файлы или пакеты) и целевой commit message. Микрозадачи обновляются сразу после коммита.

## 5. Цикл выполнения (Гейт Качества)
Для каждой подзадачи Stream из `todo-plan.md`:
1.  **Реализация**: Пиши код (помни: Микро-классы, Фасады, классы не более 300 строк).
2.  **Документация (Real-time)**: Если меняется логика или архитектура — **ОБНОВИ** `doc/Architecture/Architecture.md` (или другие доки) **ПРЯМО СЕЙЧАС**. Коммит должен содержать и код, и обновленную документацию.
3.  **Верификация**: Запусти **Обязательные Гейты**:
    ```bash
    ./scripts/check-architecture.sh  # ДОЛЖЕН ПРОЙТИ
    npx ultracite check              # Линтинг/Форматирование
    npx ts-prune                     # Мертвый код
    npx jscpd --threshold 3 --silent --reporters console src --ignore "**/node_modules/**" # Дублирование < 3%
    npm run check:links              # Битые ссылки
    npm run build --workspace <package> # Таргетная сборка
    ```
4.  **Коммит**: ТОЛЬКО после зеленых гейтов.
    - Формат сообщения: `feat: <описание>` или `fix: <описание>`
    - **Авто-обновление**: Сразу отметь пункт как `[DONE]` в `task.md` (и в `todo-plan.md`, если фича завершена).

## 6. Критические правила
- **НИКОГДА** не обходи `check-architecture.sh`.
- **НИКОГДА** не редактируй версии в `package.json` вручную (используй `build-all.sh`).
- **ВСЕГДА** держи doc/Architecture/Architecture.md и doc/Project_Docs/SystemArchitecture/SystemArchitecture.md и другие связанные с подзадачей документы из папки - doc/ в синхронизации с изменениями кода (в том же коммите).

## 7. Родные артефакты (Native Artifacts)

### 7.1. Замена стандартных артефактов
- **`implementation_plan.md`** -> **ЗАМЕНЕН НА** `doc/Project_Docs/<Feature>_Architecture.md`.
  - **Никакого отдельного `implementation_plan.md`**.
  - Этап проектирования (Design Phase) происходит **ДО** создания задач в `todo-plan.md`.
  - Ты обязан создать или обновить архитектурный документ в `doc/Project_Docs/`, утвердить его с пользователем, и только потом приступать к планированию задач.
  
- **`walkthrough.md`** -> **ЗАМЕНЕН НА** `doc/Sessions/SessionXXX.md`.
  - **Никакого отдельного `walkthrough.md`**. Лог сессии И ЕСТЬ walkthrough.

- **`task.md`** -> Используется как операционный чек-лист для текущего Stream из `todo-plan.md`.

### 7.2. Язык
- Все артефакты (`task.md`, отчеты сессий, архитектурные доки) составляй **ВСЕГДА на Русском языке**!

## 8. Release Build Checklist
1. **Подготовка**: Убедись, что dependencies установлены (`npm install`) и в корне проекта, и в `webview-ui`.
2. **Чистое состояние**: `git status` должен быть пустым. Все текущие задачи должны быть закрыты и закоммичены.
3. **Build Script**:
   - Для выпуска новой версии: `./scripts/build-release.sh`
   - Для пересборки текущей версии: `./scripts/build-release.sh --use-current-version`
   - Скрипт выполнит: Clean -> Version Bump -> Webview Build -> Architecture Check -> Compile -> Package VSIX.
4. **Проверка**:
   - Убедись, что файл `multicli-agents-<version>.vsix` появился в корне.
   - Проверь отсутствие ошибок в консоли.
5. **Фиксация**:
   - Если версия была обновлена, закоммить `package.json`: `git commit -am "chore: release v<version>"`.
   - Обнови `doc/TODO/todo-plan.md` и `doc/Sessions/SessionXXX.md`.
6. **Публикация**:
   - `git push origin main`.
   - Передай `.vsix` пользователю или создай GitHub Release.

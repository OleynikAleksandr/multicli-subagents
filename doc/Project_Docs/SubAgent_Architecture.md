# Архитектура системы Sub-Agent для Codex CLI

## Описание проблемы

Codex CLI не имеет встроенного механизма для запуска Sub-Agent'ов из основного диалога. Пользователь хочет делегировать задачи в фоновый процесс, сохраняя возможность продолжить сессию Sub-Agent'а при необходимости.

## Решение

Bash-скрипт `codex-setup-subagents.sh`, который создаёт инфраструктуру для работы с Sub-Agent'ами в любом воркспейсе.

---

## Архитектура

```
workspace/
├── AGENTS.md                          ← Основной агент (Codex читает)
├── .codex/
│   ├── prompts/
│   │   └── subagent.md                ← Кастомная slash-команда
│   └── subagents/
│       └── <имя-агента>/
│           └── <имя-агента>.md        ← Инструкция Sub-Agent'а
└── ...кодовая база...
```

> [!IMPORTANT]  
> **Файл инструкций Sub-Agent'а НЕ должен называться `AGENTS.md`!**  
> Codex ищет `AGENTS.md` во всех вложенных папках и прочтёт его при старте основной сессии.  
> **Решение:** `<имя-агента>.md` — уникальное имя, совпадающее с именем папки.

---

## Компоненты

### 1. Кастомная Slash-команда `/subagent`

**Файл:** `.codex/prompts/subagent.md`

```markdown
---
description: Запустить Sub-Agent для выполнения задачи в фоне
argument-hint: <имя-агента> <описание-задачи>
---

# Инструкции по запуску Sub-Agent

Ты — Основной Агент. Пользователь хочет делегировать задачу Sub-Agent'у.

## Параметры
- **Имя агента:** $1
- **Описание задачи:** $ARGUMENTS (всё после имени агента)

## Твои действия

1. **Проверь существование Sub-Agent'а:**
   Проверь, существует ли файл `.codex/subagents/$1/$1.md`.
   Если нет — сообщи пользователю и предложи создать.

2. **Запусти Sub-Agent через bash:**
   Выполни команду:

   ```bash
   codex exec \
     --full-auto \
     --add-dir "$(pwd)" \
     -C "$(pwd)" \
     "Сначала прочитай .codex/subagents/$1/$1.md для получения инструкций. Затем выполни: $ARGUMENTS" \
     2>&1 | tee /tmp/subagent-$1-output.log &
   ```

3. **Сохрани Session ID:**
   Извлеки `session_id` из вывода команды — он понадобится для продолжения.

4. **Автономное продолжение (без участия пользователя):**
   Проанализируй вывод Sub-Agent'а. Если он содержит вопросы или запросы уточнений:
   - **Сам ответь** на вопросы Sub-Agent'а, используя свой контекст
   - Продолжи его сессию:
   ```bash
   codex exec resume <SESSION_ID> "<твой ответ на вопросы Sub-Agent'а>"
   ```
   - Повторяй до получения финального результата

## Примечания
- Sub-Agent имеет ПОЛНЫЙ доступ к воркспейсу через `--add-dir`
- Sub-Agent читает ТОЛЬКО свои инструкции из `<имя-агента>.md`
- `--full-auto` включает автоматическое одобрение команд
```

### 2. Структура песочницы Sub-Agent'а

**Директория:** `.codex/subagents/<имя-агента>/`

- `<имя-агента>.md` — Инструкции для Sub-Agent'а

**Пример:**
```
.codex/subagents/
└── code-reviewer/
    └── code-reviewer.md
```

---

## Флаги codex exec

- `--full-auto` — автоматическое одобрение + sandbox workspace-write
- `--add-dir $(pwd)` — полный доступ к воркспейсу
- `-C $(pwd)` — рабочая директория = корень репозитория

---

## Скрипт `codex-setup-subagents.sh` (v1 - MVP)

### Что создаёт

1. `.codex/prompts/subagent.md` — slash-команда
2. `.codex/subagents/` — директория для Sub-Agent'ов
3. `.codex/subagents/example/example.md` — пример Sub-Agent'а

---

## План верификации

1. Запустить `./codex-setup-subagents.sh` в тестовом воркспейсе
2. Проверить структуру: `tree .codex/`
3. Запустить Codex CLI интерактивно
4. Вызвать `/subagent example "Создай файл hello.txt"`
5. Проверить выполнение и возможность resume
